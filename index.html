<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>WebAssembly Developer Experience</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/black.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">

		<style>
			.hljs {
				font-size: 0.8em;
				line-height: 1.2em;
			}
		</style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<img src="assets/wasm-logo.svg" style="height: 180px; margin: 0 auto 4rem auto; background: transparent;">
					<h2>WebAssembly Developper Experience</h2>
					<p>Sébastien Deleuze - MiXiT 2022</p>
				</section>

				<section>
					<section>
						<h2>Définition</h2>
					</section>

					<section>
						<p>
							WebAssembly est un format binaire d'instructions pour machine virtuelle à base de pile.
						</p>
					</section>

					<section>
						<p>
							Wasm est l'abréviation de WebAssembly.
						</p>
					</section>

					<section>
						<p>
							Wasm est conçu comme une cible de compilation portable pour les langages de programmation, permettant le déploiement sur le web (mais pas que) pour les applications client et serveur.
						</p>
					</section>
				</section>

				<section>
					<section>
						<h2>Caractéristiques</h2>
					</section>

					<section>
						<h3>Efficacité</h3>
						<p>Format compact conçu pour être chargé efficacement.</p>
					</section>

					<section>
						<h3>Portabilité</h3>
						<p>Indépendant de l'architecture CPU, du système d'exploitation ou du navigateur cible.</p>
					</section>

					<section>
						<h3>Rapidité</h3>
						<p>Vitesse d'exécution proche de celle du code natif.</p>
					</section>

					<section>
						<h3>Sécurité</h3>
						<p>Modèle d'exécution isolé (sandboxed) avec gestion de la securité basée sur la notion de capacité et gestion de la mémoire sécurisée.</p>
					</section>

					<section>
						<h3>Débogable</h3>
						<p>Le format texte WAT permet de lire, déboguer, optimiser, ou même d'écrire du code WebAssembly à la main.</p>
					</section>

					<section>
						<h3>Standard ouvert</h3>
						<p>Wasm est développé sous l'égide du W3C via une collaboration impliquant de nombreuses entreprises et contributeurs individuels (1415 participants).</p>
					</section>

				</section>

				<section>

					<section>
						<h2>Plongée dans le coeur de WebAssembly</h2>
					</section>

					<section>
						<div class="r-hstack justify-center">
							<div><img src="assets/module.jpg" style="height: 800px; margin: 0 auto 4rem auto; background: transparent;"></div>
							<div>
								<h3>Examples d'hôtes</h3>
								<ul>
									<li>Un navigateur</li>
									<li>Un runtime JavaScript</li>
									<li>Un runtime WebAssembly</li>
								</ul>
							</div>
						</div>
					</section>

					<section>
						<h3>Ecrire du WebAssembly au format texte</h3>
					</section>

					<section>
						<h2 data-id="code-title">add.wat</h2>
						<pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="1|2|3-5|6">
							(module
								(func $add (param $a i32) (param $b i32) (result i32)
									local.get $a
									local.get $b
									i32.add)
								(export "add" (func $add))
							)
						</code></pre>
					</section>

					<section>
						<h2 data-id="code-title">add.js</h2>
						<pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="1|3">
							WebAssembly.instantiateStreaming(fetch('add.wasm'))
							.then(obj => {
								console.log(obj.instance.exports.add(1, 2));  // "3"
							});
						</code></pre>
					</section>
				
					<section>
						<h3>Plus loin avec WAT and Canvas</h3>
					</section>

					<section>
						<h2 data-id="code-title">fire.html</h2>
						<pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers>
							&lt;!DOCTYPE html&gt;
							&lt;head&gt;
								&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;fire.css&quot; media=&quot;screen&quot; /&gt;
								&lt;script type=&quot;text/javascript&quot; src=&quot;fire.js&quot;&gt;&lt;/script&gt;
							&lt;/head&gt;
							&lt;body&gt;
								&lt;canvas width=&quot;320&quot; height=&quot;168&quot;&gt;&lt;/canvas&gt;
							&lt;/body&gt;		
						</code></pre>
					</section>

					<section>
						<h2 data-id="code-title">fire.js</h2>
						<pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="2|4|9-15">
							let imports = { '': { rand: Math.random } };
							WebAssembly.instantiateStreaming(fetch('fire.wasm'), imports)
								.then(results => {
									let canvasData = new Uint8Array(results.instance.exports.mem.buffer, 53760, 215040);
									let canvas = document.querySelector('canvas');
									let context = canvas.getContext('2d');
									let imageData = context.createImageData(320, 168);

									let update = function () {
										requestAnimationFrame(update);
										results.instance.exports.run();
										imageData.data.set(canvasData);
										context.putImageData(imageData, 0, 0);
									};
									update();
								});
						</code></pre>
					</section>

					<section>
						<h2 data-id="code-title">fire.wat</h2>
						<pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="6|12|15-22|24-107|107">
							;; FIRE_WIDTH = 320
							;; FIRE_HEIGHT = 168
							;; FIRE_WIDTH * FIRE_HEIGHT = 53760
							;; FIRE_WIDTH * (FIRE_HEIGHT - 1) = 53440

							(import "" "rand" (func $random (result f64)))

							;; 5 pages * 64KiB bytes per page:
							;; [0, 53760)       => firePixels, 1 byte per pixel.
							;; [53760, 268800)  => canvasData, 4 bytes per pixel.
							;; [268800, 268948) => Palette data, RGBA.
							(memory (export "mem") 5)

							;; Palette data.
							(data (i32.const 268800)
							"\07\07\07\FF\1F\07\07\FF\2F\0F\07\FF\47\0F\07\FF\57\17\07\FF\67\1F\07\FF"
							"\77\1F\07\FF\8F\27\07\FF\9F\2F\07\FF\AF\3F\07\FF\BF\47\07\FF\C7\47\07\FF"
							"\DF\4F\07\FF\DF\57\07\FF\DF\57\07\FF\D7\5F\07\FF\D7\5F\07\FF\D7\67\0F\FF"
							"\CF\6F\0F\FF\CF\77\0F\FF\CF\7F\0F\FF\CF\87\17\FF\C7\87\17\FF\C7\8F\17\FF"
							"\C7\97\1F\FF\BF\9F\1F\FF\BF\9F\1F\FF\BF\A7\27\FF\BF\A7\27\FF\BF\AF\2F\FF"
							"\B7\AF\2F\FF\B7\B7\2F\FF\B7\B7\37\FF\CF\CF\6F\FF\DF\DF\9F\FF\EF\EF\C7\FF"
							"\FF\FF\FF\FF")

							(func $setup
							(local $i i32)

							;; Fill bottom row with color 36, (R=0xff, G=0xff, B=0xff).
							(local.set $i (i32.const 320))
							(loop
								;; memory[53440 - 1 + i] = 36
								(i32.store8 offset=53439 (local.get $i) (i32.const 36))
								;; loop if --i != 0
								(br_if 0
								(local.tee $i (i32.sub (local.get $i) (i32.const 1))))))

							;; Run setup at start.
							(start $setup)

							(func (export "run")
							(local $i i32)
							(local $pixel i32)
							(local $randIdx i32)

							;; Update the fire.
							(loop $xloop
								(loop $yloop
								(if
									;; if (pixel = memory[i += 320]) != 0
									(local.tee $pixel
									(i32.load8_u
										(local.tee $i
										(i32.add (local.get $i) (i32.const 320)))))
									(then
									;; randIdx = round(random() * 3.0) & 3
									(local.set $randIdx
										(i32.and
										(i32.trunc_f64_u
											(f64.nearest
											(f64.mul
												(call $random)
												(f64.const 3))))
										(i32.const 3)))

									;; memory[i - randIdx - 319] = pixel - (randIdx & 1)
									(i32.store8
										(i32.sub
										(i32.sub
											(local.get $i)
											(local.get $randIdx))
										(i32.const 319))
										(i32.sub
										(local.get $pixel)
										(i32.and
											(local.get $randIdx)
											(i32.const 1)))))
									(else
									;; memory[i - 320] = 0
									(i32.store8
										(i32.sub (local.get $i) (i32.const 320))
										(i32.const 0))))

								;; loop if i < 53760 - 320
								(br_if $yloop
									(i32.lt_u (local.get $i) (i32.const 53440))))

								;; i -= 53760 - 320 - 1, loop if i != 320
								(br_if $xloop
								(i32.ne
									(local.tee $i (i32.sub (local.get $i) (i32.const 53439)))
									(i32.const 320))))

							;; copy from firePixels to canvasData, using palette data.
							(local.set $i (i32.const 53760))
							(loop
								;; --i
								(local.set $i (i32.sub (local.get $i) (i32.const 1)))

								;; memory[53760 + (i << 2)] = memory[268800 + (memory[i] << 2)]
								(i32.store offset=53760
								(i32.shl (local.get $i) (i32.const 2))
								(i32.load offset=268800
									(i32.shl
									(i32.load8_u (local.get $i))
									(i32.const 2))))

								;; loop if i != 0
								(br_if 0 (local.get $i))))

						</code></pre>
					</section>

					<section data-background-color="white" 	data-background-iframe="assets/doomfire/index.html" data-background-interactive></section>
	
					<section>D'autres exemples sur <a href="https://github.com/binji/raw-wasm">https://github.com/binji/raw-wasm</a>.</section>

					<section><img src="assets/art-of-webassembly.png"/></section>
					
				</section>

				<section>
					<section>
						<h3>Porter du code natif sur le Web avec</h3>
						<img src="assets/Emscripten.png" />
					</section>

					<section>
						<h3>Porter Autocad sur le Web?</h3>
						<a href="https://web.autocad.com/" target="_blank">Demo</a>
					</section>

					<section data-background-iframe="https://dustinbrett.com/" data-background-interactive></section>					

				</section>
				

			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
